<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Tekken 8 IFL Tournament Control Panel</title>
        <style>
            .player-section {
                background: #e9e9e9;
                padding: 15px;
                border-radius: 6px;
                margin-bottom: 20px;
                width: 48%;
            }
            .player-controls {
                display: flex;
                justify-content: space-between;
                margin-bottom: 20px;
            }
            .player-section h3 {
                margin-top: 0;
                text-align: center;
                color: #333;
            }
            body {            
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
                background: #f0f2f5; 
                padding: 20px; 
                color: #1c1e21;
            }

            .container {
                max-width: 700px;
                margin: auto;
                background: #ffffff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            h1, h2 {
                text-align: center;
                color:#1877f2;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 10px;
                font-weight: 600;
            }
            input[type="text"], select {
                width: 95%;
                padding: 10px;
                border: 1px solid #dddfe2;
                border-radius: 6px;
                font-size: 16px;
            }
            .score-controls {
                display: flex;
                justify-content: space-around;
                align-items: center;
                text-align: center;
                background: #e9e9e9;
                padding: 15px;
                border-radius: 6px;
                margin-bottom: 20px;
            }
            .player-score {
                display: flex;
                align-items: center;
                flex-direction: column;
            }
            .player-section h3 {
                margin-top: 0;
                text-align: center;
                color: #333;
            }
            .player-score h3 {
                margin-bottom: 10px;
            }
            .score-display {
                font-size: 22px;
                font-weight: bold;
                margin: 0 10px;
                min-width: 30px;
                text-align: center;
            }

            button {
                border: none;
                padding: 10px 15px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                transition: background 0.2s;
            }
            .score-btn {
                background: #e4e6eb;
                color: #1c1e21;
                font-size: 18px;
                margin: 5 5px;
            }
            .score-btn:hover {
                background-color: #d8dbdf;
            }
            button.swap-btn {
                background: #42b72a;
                color: #fff;
                width: 100%;
                padding: 15px;
                font-size: 16px;
            }
            button.swap-btn:hover {
                background-color: #36a420;
            }
            button.update {
                background: #42b72a;
                color: #fff;
                width: 100%;
                padding: 15px;
                font-size: 16px;
            }
            button.update:hover {
                background-color: #36a420;
            }
            button.reset {
                background: #fa3e3e;
                color: #fff;
                display: block;
                margin: 20px auto 0 auto;
                padding: 15px 30px;
                font-size: 16px;
            }
            button.reset:hover {
                background-color: #e03838;
            }
            hr {
                border: none;
                border-top: 1px solid #dddfe2;
                margin: 20px 0;

            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Tekken 8 IFL Tournament Overlay Control Panel</h1>
            <hr>
            <h2>Score Controls</h2>
            <div class="score-controls">
                <div class="player-score">
                    <h3>Player 1 Score</h3>
                    <div class="score-display" id="p1-score">0</div>
                    <div>
                        <button class="score-btn" onclick="updateScore('p1', 1)">+</button>
                        <button class="score-btn" onclick="updateScore('p1', -1)">-</button>
                    </div>
                </div>
                <div class="player-score">
                    <h3>Player 2 Score</h3>
                    <div class="score-display" id="p2-score">0</div>
                    <div>
                        <button class="score-btn" onclick="updateScore('p2', 1)">+</button>
                        <button class="score-btn" onclick="updateScore('p2', -1)">-</button>
                    </div>
                </div>
            </div>
            <button class="reset" onclick="resetScores()">Reset Scores</button>

            <hr>
            
            <div class="player-controls">
            <div class="player-section">
                <h3>Player 1</h3>
                <div class="form-group">
                    <label for="p1-flag">Player 1 Flag</label>
                    <select id="p1-flag"></select>
                </div>
                <div class="form-group">
                        <label for="p1-team">Player 1 Team</label>
                    <input type="text" id="p1-team" name="p1-team" placeholder="Enter Player 1 Team">
                </div>
                <div class="form-group">
                    <label for="p1-name">Player 1 Name</label>
                    <input type="text" id="p1-name" name="p1-name" placeholder="Enter Player 1 Name">
                </div>
            </div>
            <div class="player-section">
                <h3>Player 2</h3>
                <div class="form-group">
                    <label for="p2-flag">Player 2 Flag</label>
                    <select id="p2-flag"></select>
                </div>
                <div class="form-group">
                <label for="p2-team">Player 2 Team</label>
                <input type="text" id="p2-team" name="p2-team" placeholder="Enter Player 2 Team">
                </div>
                <div class="form-group">
                    <label for="p2-name">Player 2 Name</label>
                    <input type="text" id="p2-name" name="p2-name" placeholder="Enter Player 2 Name">
                </div>
            </div>
            </div>

            <button class="swap-btn" onclick="swapPlayers()">Swap Player Informations</button>
            
            <div class="form-group">
                <label for="round">Round</label>
                <input type="text" id="round" name="round" placeholder="Enter Round">
            </div>
            
            <button class="update" onclick="updateNamesAndRound()">Update Player Names, Teams and Round informations</button>
            <div class="form-group">
                <label for="event-number">Event Number</label>
                <input type="text" id="event-number" name="event-number" placeholder="Enter event number">
            </div>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script>
        // Get connection key from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const connectionKey = urlParams.get('key');
        
        if (!connectionKey) {
            window.location.href = '/auth';
            throw new Error('No connection key provided');
        }

        const socket = io({
            auth: {
                token: connectionKey
            }
        });

        // Handle connection errors
        socket.on('connect_error', (error) => {
            console.error('Connection failed:', error.message);
            alert('Authentication failed. Please check your connection key.');
            window.location.href = '/auth';
        });


        const countries = {
            "": "No Flag", "US": "United States", "JP": "Japan", "KR": "South Korea", "FR": "France",
            "DE": "Germany", "GB": "United Kingdom", "IT": "Italy", "ES": "Spain", "BR": "Brazil",
            "PK": "Pakistan", "SA": "Saudi Arabia", "AE": "UAE", "CA": "Canada", "MX": "Mexico",
            "CN": "China", "FI": "Finland", "SE": "Sweden", "NO": "Norway", "AU": "Australia", "PR": "Puerto Rico",
            "RO": "Romania", "PL": "Poland", "CZ": "Czech Republic", "HU": "Hungary", "NL": "Netherlands",
            "BE": "Belgium", "BG": "Bulgaria", "HR": "Croatia", "DK": "Denmark", "EE": "Estonia", "IE": "Ireland",
            "LV": "Latvia", "LT": "Lithuania", "MT": "Malta", "PT": "Portugal", "SK": "Slovakia", "SI": "Slovenia",
            "CH": "Switzerland", 'IL': 'israel'
        };

        function populateDropdowns() {
            const p1FlagSelect = document.getElementById('p1-flag');
            const p2FlagSelect = document.getElementById('p2-flag');
            for (const code in countries) {
                p1FlagSelect.add(new Option(countries[code], code));
                p2FlagSelect.add(new Option(countries[code], code));
            }
        }
        document.addEventListener('DOMContentLoaded', populateDropdowns);

        let data = {};
        socket.on('data-update', (serverData) => {
           console.log('Retrieved data from server:', serverData);
           data = serverData;

           document.getElementById('p1-flag').value = data.p1Flag;
           document.getElementById('p1-team').value = data.p1Team;
           document.getElementById('p1-name').value = data.p1Name;
               document.getElementById('p1-score').textContent = data.p1Score;
           
           
           document.getElementById('p2-flag').value = data.p2Flag;
           document.getElementById('p2-team').value = data.p2Team;
           document.getElementById('p2-name').value = data.p2Name;
               document.getElementById('p2-score').textContent = data.p2Score;
           document.getElementById('round').value = data.round;
           document.getElementById('event-number').value = data.eventNumber;
        });

        function sendUpdate() {
            socket.emit('update-data', data);
        }

        function updateNamesAndRound() {
            data.p1Flag = document.getElementById('p1-flag').value;
            data.p1Team = document.getElementById('p1-team').value;
            data.p1Name = document.getElementById('p1-name').value;
            data.p2Flag = document.getElementById('p2-flag').value;
            data.p2Team = document.getElementById('p2-team').value;
            data.p2Name = document.getElementById('p2-name').value;
            data.round = document.getElementById('round').value;
            data.eventNumber = document.getElementById('event-number').value;
            sendUpdate();
        }

        function swapPlayers() {
            const p1Flag = document.getElementById('p1-flag').value;
            const p1Team = document.getElementById('p1-team').value;
            const p1Name = document.getElementById('p1-name').value;
            const p2Flag = document.getElementById('p2-flag').value;
            const p2Team = document.getElementById('p2-team').value;
            const p2Name = document.getElementById('p2-name').value;

            // Swap form values
            document.getElementById('p1-flag').value = p2Flag;
            document.getElementById('p1-team').value = p2Team;
            document.getElementById('p1-name').value = p2Name;
            document.getElementById('p2-flag').value = p1Flag;
            document.getElementById('p2-team').value = p1Team;
            document.getElementById('p2-name').value = p1Name;
            
            // Also swap scores in data object
            const tempScore = data.p1Score;
            data.p1Score = data.p2Score;
            data.p2Score = tempScore;
            
            // Update data object with new form values and send update
            updateNamesAndRound();
        }

        function updateScore(player, change) {
            data[`${player}Score`] += change;
            if (data[`${player}Score`] < 0) {
                data[`${player}Score`] = 0;
            }
            sendUpdate();
        }

        function resetScores() {
            data.p1Score = 0;
            data.p2Score = 0;
            sendUpdate();
        }
    </script>
    </body>
</html>