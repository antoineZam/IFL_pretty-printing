<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tag Team Tournament Overlay</title>
    <style>
        @font-face {
            font-family: 'Archivo Extra Condensed Bold';
            src: url('../source/fonts/Archivo/static/Archivo_ExtraCondensed-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Archivo Extra Condensed SemiBold';
            src: url('../source/fonts/Archivo/static/Archivo_ExtraCondensed-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Archivo Condensed Bold';
            src: url('../source/fonts/Archivo/static/Archivo_Condensed-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Archivo Condensed Regular';
            src: url('../source/fonts/Archivo/static/Archivo_Condensed-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'Archivo Semi Condensed Bold';
            src: url('../source/fonts/Archivo/static/Archivo_SemiCondensed-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'Archivo Semi Condensed SemiBold';
            src: url('../source/fonts/Archivo/static/Archivo_SemiCondensed-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
        }

        @font-face {
            font-family: 'Archivo Semi Condensed Regular';
            src: url('../source/fonts/Archivo/static/Archivo_SemiCondensed-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Archivo Expanded Regular';
            src: url('../source/fonts/Archivo/static/Archivo_Expanded-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'Archivo Expanded Bold';
            src: url('../source/fonts/Archivo/static/Archivo_Expanded-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'Archivo Semi Expanded Bold';
            src: url('../source/fonts/Archivo/static/Archivo_SemiExpanded-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'Archivo Bold';
            src: url('../source/fonts/Archivo/static/Archivo-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        body {
            background-color: transparent;
            font-family: 'Archivo Extra Condensed Bold', sans-serif;
            color: #fff;
            text-transform: uppercase;
            margin: 0;
            width: 1920px;
            height: 1080px;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Dynamic image loaded based on active players:
           team1.png = Team 1 Player 1 vs Team 2 Player 1
           team2.png = Team 1 Player 2 vs Team 2 Player 1
           team3.png = Team 1 Player 1 vs Team 2 Player 2
           team4.png = Team 1 Player 2 vs Team 2 Player 2
        */
        .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 1920px;
            height: 1080px;
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center;
            transition: background-image 0.3s ease;
        }

        .text-shadow {
            text-shadow: 2px 2px 2px rgba(0, 0, 0, 0.2);
        }

        /* Players Container - All 4 players displayed equally */
        .players-container {
            position: absolute;
            top: 1px;
            width: 100%;
            height: 100px;
        }

        #team1-players {
            left: 0;
        }

        #team2-players {
            right: 0;
        }

        /* Anchor line between players */
        .anchor-line {
            width: 2px;
            height: 30px;
            background: #ffd700;
            opacity: 0;
            position: absolute;
            top: 28px;
        }

        #team1-players .anchor-line {
            left: 427px;
        }

        #team2-players .anchor-line {
            right: 423px;
        }

        .player-card {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            gap: 8px;
            max-width: 250px;
            overflow: hidden;
            justify-content: center;
        }

        /* Active player styling (default) */
        .player-sponsor {
            color: #ffffff;
            opacity: 0.5;
            font-size: 18px;
            font-family: 'Archivo Extra Condensed SemiBold', sans-serif;
            font-weight: 600;
            white-space: nowrap;
        }

        .player-name {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            opacity: 1;
            white-space: nowrap;
        }

        /* Inactive player styling - reduced opacity for both */
        .player-card.inactive .player-sponsor {
            opacity: 0.3;
        }

        .player-card.inactive .player-name {
            opacity: 0.5;
        }

        /* Individual Player Positioning - Anchored to fixed positions */
        .t1-p1-card {
            /* Team 1 Player 1 - writes from LEFT EDGE to anchor (stops 12px before anchor at 427px) */
            position: absolute;
            top: 28px; /* Base position, will be adjusted by JS */
            left: 195px;
            right: calc(100% - 415px);
        }

        .t1-p2-card {
            /* Team 1 Player 2 - STARTS FROM anchor at 427px (starts 5px after) */
            position: absolute;
            top: 28px; /* Base position, will be adjusted by JS */
            left: 432px;
            width: 258px;
        }

        .t2-p1-card {
            /* Team 2 Player 1 - writes from RIGHT EDGE to anchor (stops 13px before anchor at 423px from right) */
            position: absolute;
            top: 28px; /* Base position, will be adjusted by JS */
            right: 195px;
            left: calc(100% - 410px);
        }

        .t2-p2-card {
            /* Team 2 Player 2 - STARTS FROM anchor at 423px (starts 5px after from right) */
            position: absolute;
            top: 28px; /* Base position, will be adjusted by JS */
            right: 428px;
            width: 262px;
        }

        /* Scores */
        .score {
            font-family: 'Archivo Expanded Regular', sans-serif;
            position: absolute;
            top: 0px;
            font-size: 27px;
            width: 100px;
            text-align: center;
            font-weight: 700;
        }

        #team1-score {
            left: 690px;
        }

        #team2-score {
            right: 690px;
        }

        /* Round */
        #round {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            text-align: center;
            width: 600px;
            word-spacing: 5px;
            letter-spacing: 2px;
            font-weight: 600;
        }

        /* Player Labels (for debugging/identification) */
        .player-label {
            font-size: 12px;
            color: #888;
            opacity: 0; /* Hidden by default, can be shown for debugging */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="background-image" id="overlay-image"></div>
        
        <!-- Team 1 Players -->
        <div class="players-container text-shadow" id="team1-players">
            <div class="player-card t1-p1-card" id="t1-p1-card">
                <span class="player-sponsor" id="t1-p1-sponsor"></span>
                <span class="player-name" id="t1-p1-name">Player 1</span>
            </div>
            <div class="anchor-line"></div>
            <div class="player-card t1-p2-card" id="t1-p2-card">
                <span class="player-sponsor" id="t1-p2-sponsor"></span>
                <span class="player-name" id="t1-p2-name">Player 2</span>
            </div>
        </div>
        <div class="score text-shadow" id="team1-score">0</div>

        <!-- Team 2 Players -->
        <div class="players-container text-shadow" id="team2-players">
            <div class="player-card t2-p1-card" id="t2-p1-card">
                <span class="player-sponsor" id="t2-p1-sponsor"></span>
                <span class="player-name" id="t2-p1-name">Player 1</span>
            </div>
            <div class="anchor-line"></div>
            <div class="player-card t2-p2-card" id="t2-p2-card">
                <span class="player-sponsor" id="t2-p2-sponsor"></span>
                <span class="player-name" id="t2-p2-name">Player 2</span>
            </div>
        </div>
        <div class="score text-shadow" id="team2-score">0</div>

        <!-- Round -->
        <div class="round text-shadow" id="round"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Get connection key from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const connectionKey = urlParams.get('key');
        
        if (!connectionKey) {
            console.error('No connection key provided');
            // For overlay, don't redirect (OBS might be using this)
            document.body.innerHTML = '<div style="color: red; text-align: center; font-size: 24px; margin-top: 50px;">Error: No Connection Key</div>';
        }

        const socket = io({
            auth: {
                token: connectionKey
            }
        });

        // Handle connection errors
        socket.on('connect_error', (error) => {
            console.error('Connection failed:', error.message);
            document.body.innerHTML = '<div style="color: red; text-align: center; font-size: 24px; margin-top: 50px;">Authentication Error: Invalid Connection Key</div>';
        });

        // Listen for tag team data updates
        socket.on('tag-team-data', (data) => {
            console.log('Tag team data received:', data);
            updateOverlay(data);
        });

        function determineOverlayImage(data) {
            // Find which player is active on each team
            const team1ActiveIndex = data.team1.players.findIndex(p => p.active);
            const team2ActiveIndex = data.team2.players.findIndex(p => p.active);
            
            // Default to first player if none active
            const team1Index = team1ActiveIndex !== -1 ? team1ActiveIndex : 0;
            const team2Index = team2ActiveIndex !== -1 ? team2ActiveIndex : 0;
            
            // Calculate image number (1-4) based on active player combinations:
            // USE CASE 1: Team 1 Player 1 active AND Team 2 Player 1 active → team1.png
            // USE CASE 2: Team 1 Player 1 active AND Team 2 Player 2 active → team2.png (SWAPPED)
            // USE CASE 3: Team 1 Player 2 active AND Team 2 Player 1 active → team3.png (SWAPPED)
            // USE CASE 4: Team 1 Player 2 active AND Team 2 Player 2 active → team4.png
            let imageNumber;
            if (team1Index === 0 && team2Index === 0) {
                imageNumber = 4; // USE CASE 1: Team 1 P1 vs Team 2 P1
            } else if (team1Index === 1 && team2Index === 0) {
                imageNumber = 3; // USE CASE 3: Team 1 P2 vs Team 2 P1 (SWAPPED)
            } else if (team1Index === 0 && team2Index === 1) {
                imageNumber = 2; // USE CASE 2: Team 1 P1 vs Team 2 P2 (SWAPPED)
            } else {
                imageNumber = 1; // USE CASE 4: Team 1 P2 vs Team 2 P2
            }
            
            return imageNumber;
        }

        function adjustFontSize(elementId, text, baseSize = 27) {
            const element = document.getElementById(elementId);
            if (!element || !text) {
                if(element) element.style.fontSize = ''; // Reset size
                return baseSize;
            }

            const parent = element.parentElement;
            const containerWidth = parent.clientWidth;
            const targetWidth = containerWidth * 0.65;

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const baseFontSize = baseSize;
            
            let fontSize = baseFontSize;
            context.font = `700 ${fontSize}px 'Archivo Extra Condensed Bold'`;
            let textWidth = context.measureText(text).width;

            // Decrease font size until it fits
            while (textWidth > targetWidth && fontSize > 8) {
                fontSize -= 0.5;
                context.font = `700 ${fontSize}px 'Archivo Extra Condensed Bold'`;
                textWidth = context.measureText(text).width;
            }

            element.style.fontSize = `${fontSize}px`;
            return fontSize;
        }

        function adjustVerticalAlignment(cardId, nameId, baseTop = 26) {
            const card = document.getElementById(cardId);
            const nameEl = document.getElementById(nameId);
            if (!card || !nameEl) return;
            
            // Estimate initial height based on a 27px font size
            const initialHeight = 27; 
            const currentHeight = nameEl.offsetHeight;
            
            // Calculate the offset needed to keep the vertical center aligned
            const offset = (currentHeight - initialHeight) / 2;
            card.style.top = `${baseTop - offset}px`;
        }


        function updateOverlay(data) {
            console.log('updateOverlay called with data:', data);
            
            // Update Team 1 - All players
            const team1 = data.team1;
            document.getElementById('team1-score').textContent = team1.score || 0;
            
            // Team 1 Player 1
            const t1p1 = team1.players[0] || { name: '', sponsor: '', active: true };
            const t1p1Name = t1p1.name || 'Player 1';
            const t1p1Sponsor = t1p1.sponsor || '';
            const t1p1SponsorEl = document.getElementById('t1-p1-sponsor');
            document.getElementById('t1-p1-name').textContent = t1p1Name;
            t1p1SponsorEl.textContent = t1p1Sponsor;
            const t1p1NameSize = adjustFontSize('t1-p1-name', t1p1Name, 27);
            if (t1p1Sponsor) {
                t1p1SponsorEl.style.fontSize = `${Math.min(22, t1p1NameSize * 0.8)}px`;
            } else {
                t1p1SponsorEl.style.fontSize = '';
            }
            adjustVerticalAlignment('t1-p1-card', 't1-p1-name');

            const t1p1Card = document.querySelector('.t1-p1-card');
            if (t1p1.active) {
                t1p1Card.classList.remove('inactive');
                console.log('T1P1 is ACTIVE');
            } else {
                t1p1Card.classList.add('inactive');
                console.log('T1P1 is INACTIVE');
            }
            
            // Team 1 Player 2
            const t1p2 = team1.players[1] || { name: '', sponsor: '', active: false };
            const t1p2Name = t1p2.name || 'Player 2';
            const t1p2Sponsor = t1p2.sponsor || '';
            const t1p2SponsorEl = document.getElementById('t1-p2-sponsor');
            document.getElementById('t1-p2-name').textContent = t1p2Name;
            t1p2SponsorEl.textContent = t1p2Sponsor;
            const t1p2NameSize = adjustFontSize('t1-p2-name', t1p2Name, 27);
            if (t1p2Sponsor) {
                t1p2SponsorEl.style.fontSize = `${Math.min(22, t1p2NameSize * 0.8)}px`;
            } else {
                t1p2SponsorEl.style.fontSize = '';
            }
            adjustVerticalAlignment('t1-p2-card', 't1-p2-name');

            const t1p2Card = document.querySelector('.t1-p2-card');
            if (t1p2.active) {
                t1p2Card.classList.remove('inactive');
                console.log('T1P2 is ACTIVE');
            } else {
                t1p2Card.classList.add('inactive');
                console.log('T1P2 is INACTIVE');
            }

            // Update Team 2 - All players
            const team2 = data.team2;
            document.getElementById('team2-score').textContent = team2.score || 0;
            
            // Team 2 Player 1
            const t2p1 = team2.players[0] || { name: '', sponsor: '', active: true };
            const t2p1Name = t2p1.name || 'Player 1';
            const t2p1Sponsor = t2p1.sponsor || '';
            const t2p1SponsorEl = document.getElementById('t2-p1-sponsor');
            document.getElementById('t2-p1-name').textContent = t2p1Name;
            t2p1SponsorEl.textContent = t2p1Sponsor;
            const t2p1NameSize = adjustFontSize('t2-p1-name', t2p1Name, 27);
            if (t2p1Sponsor) {
                t2p1SponsorEl.style.fontSize = `${Math.min(22, t2p1NameSize * 0.8)}px`;
            } else {
                t2p1SponsorEl.style.fontSize = '';
            }
            adjustVerticalAlignment('t2-p1-card', 't2-p1-name');

            const t2p1Card = document.querySelector('.t2-p1-card');
            if (t2p1.active) {
                t2p1Card.classList.remove('inactive');
                console.log('T2P1 is ACTIVE');
            } else {
                t2p1Card.classList.add('inactive');
                console.log('T2P1 is INACTIVE');
            }
            
            // Team 2 Player 2
            const t2p2 = team2.players[1] || { name: '', sponsor: '', active: false };
            const t2p2Name = t2p2.name || 'Player 2';
            const t2p2Sponsor = t2p2.sponsor || '';
            const t2p2SponsorEl = document.getElementById('t2-p2-sponsor');
            document.getElementById('t2-p2-name').textContent = t2p2Name;
            t2p2SponsorEl.textContent = t2p2Sponsor;
            const t2p2NameSize = adjustFontSize('t2-p2-name', t2p2Name, 27);
            if (t2p2Sponsor) {
                t2p2SponsorEl.style.fontSize = `${Math.min(22, t2p2NameSize * 0.8)}px`;
            } else {
                t2p2SponsorEl.style.fontSize = '';
            }
            adjustVerticalAlignment('t2-p2-card', 't2-p2-name');

            const t2p2Card = document.querySelector('.t2-p2-card');
            if (t2p2.active) {
                t2p2Card.classList.remove('inactive');
                console.log('T2P2 is ACTIVE');
            } else {
                t2p2Card.classList.add('inactive');
                console.log('T2P2 is INACTIVE');
            }

            // Update round
            document.getElementById('round').textContent = data.round || '';

            // Update overlay background image based on active players
            const imageNumber = determineOverlayImage(data);
            const imagePath = `../source/overlay/tag_tournament/team${imageNumber}.png`;
            document.getElementById('overlay-image').style.backgroundImage = `url('${imagePath}')`;

            console.log('Overlay updated - All 4 players displayed:', {
                team1: { p1: { name: t1p1.name, sponsor: t1p1.sponsor, active: t1p1.active }, p2: { name: t1p2.name, sponsor: t1p2.sponsor, active: t1p2.active } },
                team2: { p1: { name: t2p1.name, sponsor: t2p1.sponsor, active: t2p1.active }, p2: { name: t2p2.name, sponsor: t2p2.sponsor, active: t2p2.active } },
                overlayImage: `team${imageNumber}.png`
            });
        }

        // Request initial data on connection
        socket.on('connect', () => {
            console.log('Connected to server, waiting for tag team data...');
        });
    </script>
</body>
</html>